# Разработка Data Warehouse для компании по продаже электроники

## Описание компании

Компания торгует электроникой через собственную розничную сеть и интернет-магазин.
Также происходит реализация электроники через маркетплейсы Ozon и Wildberries.
Компания работает только на территории РФ.
У компании есть программа лояльности для покупателей. Она действует в розничной сети и в интернет-магазине.
Участникам программы лояльности предоставляется скидка на товары.

## Цели проекта

1. Создание единой централизованной БД для хранения данных о продажах, поступающих из различных источников.
2. Своевременное получение доступа к качественным аналитическим данным.
3. Поддержка принятия управленческих решений.
4. Создание единой системы отчетности.
5. Прогнозирование объёмов продаж, оптимизация складских запасов, минимизация затрат логистики и маркетинга.

## Бизнес-требования

DWH дожно обеспечивать:

1. Хранение данных о продажах за последние 3 года.
2. Детализацию данных до уровня одного дня.
3. Поддержку многомерного анализа данных.
4. Разграничение доступа пользователей к данным.
5. Производительность, достаточную для ежедневного формирования необходимых отчётов к 06-00.
6. Ежедневное обновление данных в ночное время с 00-00 до 03-00.

## Системы-источники данных

Компания использует информационные системы, которые являются источниками данных для DWH:

1. Данные о продажах розничной сети и интернет-магазина хранятся в базе 1С Торговля. Для выгрузки в DWH используется веб-сервис 1С.
     Формат данных: JSON.
2. Данные о продажах на маркетплейсах предоставляются через S3-хранилище в виде файлов CSV.
     Формат данных: CSV.
3. Данные о клиентах, программе лояльности и маркетинговой активности хранятся в CRM-системе.
     Формат данных: РСУБД с доступом по ODBC.
4. Складской учёт на базе 1С БП. Для выгрузки в DWH используется веб-сервис 1С.
     Формат данных: JSON.

## Сущности и их взаимосвязи (Концептуальная модель данных)

1. Заказ - это факт продажи *товара*. Заказ состоит из одной или нескольких *позиций*. Одна позиция - один вид проданного *товара*. Каждая *позиция* содержит количество проданных товаров, стоимость единицы, суммарную стоимость, размер скидки по программе лояльности, размер скидки по *маркетинговым акциям*. У *заказа* есть дата и время, адрес доставки (если указан), ID *магазина* (розница или интернет-магазин), ID карты лояльности *клиента* (если использовалась карта лояльности). С любой из *позиций заказа* может быть связана *маркетинговая акция*.
2. Позиция заказа - позиция в чеке *заказа*.
3. Товар - это номенклатурная позиция склада. У *товара* есть *производитель*, *бренд*, модель (наименование). *Товары* объединены в номенклатурные *группы* - телевизоры, кухонная техника, аудиотехника, смартфоны и т.д.
4. Клиент - покупатель *товара*. Фамилия, имя, отчество, номер телефона (определяет *клиента*), номер карты лояльности, возраст, *регион*.
5. Магазин - место продажи *товаров*. *Магазины* - розничные и есть интернет-магазин - один на все *регионы*. *Магазины* делятся по *типам* - премиальные, стандартные и дискаунтеры. Отдельными типами можно добавить интернет-магазин и маркетплейсы.
6. Маркетинговая акция - это маркетинговая активность для привлечения *клиентов*. Ограниченный период времени. Бюджет. Акция может проводиться для розницы, для интрнет-магазина и для маркетплейсов в любых комбинациях.
7. Регион. Географический регион, в котором представлена компания.
8. Производитель - компания-производитель *товара*.
9. Бренд - торговая марка *товаров*.
10. Группа - объекдинение *товаров* по какому-то признаку.
11. Тип магазина - признак маркетингового позиционирования *магазина*.

## Логическая модель данных

### Атрибуты сущностей

1. Заказ.
    Атрибуты:
    - ID заказа (1С Торговля) - строка
    - дата заказа - ссылка на справочник дат
    - сумма заказа - числовой
    - клиент - ссылка на справочник клиентов (может быть пустой)
    - регион - ссылка на справочник регионов
    - доставка - булевский
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID даты заказа
    - ID клиента
2. Позиция заказа.
    Атрибуты:
    - заказ - ссылка на таблицу заказов
    - ID заказа (1С Торговля) - строка
    - товар - ссылка на справочник товаров
    - маркетинговая акция - ссылка на справочник акций
    - количество - целочисленный
    - цена единицы - числовой
    - размер скидки по акции - числовой
    - размер скидки по программе лояльности - числовой
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID заказа
    - ID товара
    - ID маркетинговой акции
3. Товар.
    Атрибуты:
    - ID (1С Торговля) - строка
    - наименование (оно же модель) - строка, уникальный
    - номенклатурная группа - ссылка на справочник группа
    - бренд - ссылка на справочник брендов
    - производитель - ссылка на справочник производителей
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID группы
    - ID бренда
    - ID производителя
4. Производитель товара.
    Атрибуты:
    - ID (1С Торговля) - строка
    - наименование - строка, уникальный
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - нет
5. Бренд.
    Атрибуты:
    - ID (1С Торговля) - строка
    - наименование - строка, уникальный
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - нет
6. Номенклатурная группа.
    Атрибуты:
    - ID группы (1С Торговля) - строка
    - наименование - строка, уникальный
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - нет
7. Магазин.
    Атрибуты:
    - ID магазина (1С Торговля) - строка
    - ID магазина (CRM) - строка
    - наименование - строка, уникальный
    - адрес - строка
    - регион - ссылка на справочник регионов
    - дата открытия - ссылка на справочник дат
    - дата закрытия - ссылка на справочник дат
    - статус (работает или закрыт) - булевский
    - тип магазина (дискаунтер, стандарт, премиум, сайт, Оzon, WB) - ссылка на справочник типов магазинов
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID региона
    - ID типа магазина
    - ID даты открытия (справочник дат)
    - ID даты закрытия (справочник дат)
8. Тип магазина:
    Атрибуты:
    - ID (из 1С Торговля) - строка, уникальный
    - ID (из CRM) - строка, уникальный
    - наименование - строка, уникальный, значение: (дискаунтер, стандарт, премиум, сайт, Оzon, WB)
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - нет
9. Клиент.
    Атрибуты:
    - ID клиента (из CRM) - строка
    - ID клиента (из 1С Торговля) - строка
    - ФИО - строка
    - телефон - строка
    - e-mail - строка
    - номер карты лояльности - строка
    - дата регистрации в программе лояльности - ссылка на справочник дат
    - регион - ссылка на справочник регионов
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID региона
    - ID даты регистрации (справочник дат)
10. Маркетинговая акция.
    Атрибуты:
    - наименование - строка
    - ID акции (из CRM) - строка
    - ID акции (из 1С торговля) - строка
    - дата начала - ссылка на справочник дат
    - дата завершения - ссылка на справочник дат
    - бюджет - числовой
    - регион - ссылка на справочник регионов
    - действует в рознице - булевский
    - действует в интернет-магазине - булевский
    - действует на Ozon'е - булевский
    - действует на WB - булевский
    Первичный ключ:
    - суррогатный
    Внешние ключи:
    - ID региона
    - ID даты начала (справочник дат)
    - ID даты завершения (справочник дат)
11. Регион.
    Первичный ключ:
    - суррогатный
    Атрибуты:
    - наименование (естественный ключ)
    - код региона (используется во всех источниках)

### Структура stage слоям

Данные каждой сущности складываются в отдельную таблицу. Таблицы stage слоя не связаны между собой никакими отношениями.

### Структура core слоям

В core слое есть две таблицы фактов:

1. Заказы (продажи).
2. Позиции заказов.

Сущности товар, производитель, бренд, номенклатурная группа, магазин, тип магазина, клиент, маркетинговая акция, регион являются измерениями.
Дополнительное измерение необхоимо для хранения дат.

### Отображение сущностей на таблицы

|Сущность|Stage слой|Core Слой|
|---|---|---|
|Заказ|STG_ORDERS|FACT_ORDERS|
|Позиция заказа|STG_ORDER_POSITIONS|FACT_ORDERS_PRODUCTS|
|Товар|STG_PRODUCTS|DIM_PRODUCTS|
|Производитель товара|STG_MANUFACTURERS|DIM_MANUFACTURERS|
|Бренд|STG_BRANDS|DIM_BRANDS|
|Номенклатурная группа|STG_GROUPS|DIM_GROUPS|
|Магазин|STG_SHOPS|DIM_SHOPS|
|Тип магазина|STG_SHOP_TYPES|DIM_SHOP_TYPES|
|Клиент|STG_CUSTOMERS|DIM_CUSTOMERS|
|Маркетинговая акция|STG_CAMPAIGNS|DIM_CAMPAIGNS|
|Регион|STG_REGIONS|DIM_REGIONS|
|Даты|-|DIM_DATE|

См. схемы в файлах [STAGE_LAYER.drawio.pdf](./STAGE_LAYER.drawio.pdf) и [CORE_LAYER.drawio.pdf](./CORE_LAYER.drawio.pdf).

### Разложение данных по слоям

1. Stage слой

    - Хранит сырые данные из источников
    - Сохраняет исходные форматы данных
    - Не производится очистка и трансформация

2. ODS слой

    - Хранит очищенные данные из источников
    - Производится базовая валидация
    - Удаляются дубликаты
    - Сохраняется история изменений

3. DDS слой

    - Хранит структурированные данные
    - Создаются измерения и факты
    - Применяются бизнес-правила
    - Обеспечивается целостность данных

4. Datamart слой

    - Хранит готовые витрины данных
    - Оптимизирован для аналитики
    - Содержит агрегированные данные
    - Предназначен для конечных пользователей
